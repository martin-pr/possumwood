###########################################################
# INSTALL TARGETS

message("***** Install prefix = ${CMAKE_INSTALL_PREFIX} *****")

set(DATA_PREFIX "${CMAKE_INSTALL_PREFIX}/share/possumwood" CACHE STRING "")

option(MAKE_CONF_FILE "Generate config file" ON)
set(CONF_PATH ${CMAKE_INSTALL_PREFIX}/etc/possumwood.conf CACHE STRING "")
set(PLUGINS_INSTALL_PATH ${CMAKE_INSTALL_PREFIX}/lib/possumwood/plugins CACHE STRING "")
set(EXAMPLES_INSTALL_PATH ${DATA_PREFIX}/examples CACHE STRING "")
set(TOOLBARS_INSTALL_PATH ${DATA_PREFIX}/toolbars CACHE STRING "")

if(MAKE_CONF_FILE)
	message("  Generated config file: ${CMAKE_CURRENT_BINARY_DIR}/possumwood.conf")
else(MAKE_CONF_FILE)
	message("  No config file being autogenerated. Please put one to ${CONF_PATH} during installation.")
endif(MAKE_CONF_FILE)

message("  Master config file: ${CONF_PATH}")
message("  Plugins directory: ${PLUGINS_INSTALL_PATH}")
message("  Examples directory: ${EXAMPLES_INSTALL_PATH}")
message("  Toolbars directory: ${TOOLBARS_INSTALL_PATH}")

# generate the config file content
if(${MAKE_CONF_FILE})
	add_custom_target(
		config ALL
		COMMAND bash -cx \"printf \\\"EXAMPLES ${EXAMPLES_INSTALL_PATH}\\nTOOLBARS ${TOOLBARS_INSTALL_PATH}\\nPLUGINS ${PLUGINS_INSTALL_PATH}\\n\\\" > \\\"${CMAKE_CURRENT_BINARY_DIR}/possumwood.conf\\\"\"
	)

	get_filename_component(CONF_DIR ${CONF_PATH} DIRECTORY)
	install(FILES ${CMAKE_CURRENT_BINARY_DIR}/possumwood.conf DESTINATION ${CONF_DIR})
endif(${MAKE_CONF_FILE})

# copy all toolbars and examples
FILE(GLOB TOOLBARS "${PROJECT_SOURCE_DIR}/toolbars/*")
install(DIRECTORY ${TOOLBARS} DESTINATION ${TOOLBARS_INSTALL_PATH})

install(DIRECTORY ${PROJECT_SOURCE_DIR}/examples DESTINATION ${DATA_PREFIX})

# pass the config file explicitly to C++
add_definitions(-DPOSSUMWOOD_CONF_PATH=${CONF_PATH})


###########################################################
# BUILDING THE SDK

include_directories(./)

# Building the library
file(GLOB_RECURSE headers *.h)
file(GLOB_RECURSE sources *.cpp)

# Qt fun
FIND_PACKAGE(Qt5 REQUIRED COMPONENTS Core Gui Widgets OpenGL)
set(LIBS ${LIBS} Qt5::Widgets)

QT5_WRAP_CPP(headers_moc ${headers})
add_definitions(${QT_DEFINITIONS})
add_library(possumwood_sdk SHARED ${sources})
install(TARGETS possumwood_sdk DESTINATION lib)

# Final linking
target_link_libraries(possumwood_sdk ${LIBS} GLU GLEW dependency_graph actions)
